/*
*
* @ezuikit/utils-service v1.0.0-alpha.10
* Copyright (c) 2024-5-22 Ezviz-OpenBiz
* Released under MIT the License.
*
*/
import{pick as e}from"@ezuikit/utils-tools";import t from"dayjs";var n="https://open.ys7.com";function o(e,t){return new Promise((function(n,o){fetch(e,t).then((function(e){return e.json()})).then((function(e){var t,a;if(200==+e.code||0==+(null==(t=e.meta)?void 0:t.code)||200==+(null==(a=e.meta)?void 0:a.code))n(e);else{if(e.meta)return e.meta.msg=e.meta.message,void o(e.meta);o(e)}})).catch((function(e){if(e.meta)return e.meta.msg=e.meta.message,void o(e.meta);o(e)}))}))}function a(e,t,n,o,a,i,r){try{var s=e[i](r),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(o,a)}function i(e,t){var n,o,a,i,r={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,o&&(a=2&i[0]?o.return:i[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,i[1])).done)return a;switch(o=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return r.label++,{value:i[1],done:!1};case 5:r.label++,o=i[1],i=[0];continue;case 7:i=r.ops.pop(),r.trys.pop();continue;default:if(!(a=r.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){r=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){r.label=i[1];break}if(6===i[0]&&r.label<a[1]){r.label=a[1],a=i;break}if(a&&r.label<a[2]){r.label=a[2],r.ops.push(i);break}a[2]&&r.ops.pop(),r.trys.pop();continue}i=t.call(e,r)}catch(e){i=[6,e],o=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function r(e,t){if(e&&"[object FormData]"!==Object.prototype.toString.call(e)){var r,s=new FormData;Object.entries(e).forEach((function(e){var t=e[0],n=e[1];s.append(t,n)})),s.append("version",null!=(r=e.version)?r:"2.0"),e=s}return new Promise((function(r,s){var l=function(){return u.apply(this,arguments)},c=[];function u(){var d;return d=function(){var a,u,d,p;return i(this,(function(i){switch(i.label){case 0:return[4,o((null!=t?t:n)+"/api/lapp/video/by/time",{method:"POST",body:e})];case 1:return(u=i.sent()).data&&Array.isArray(u.data)?(c=c.concat(u.data),r({code:200,data:c,msg:""}),[2]):(!Array.isArray(u.data)&&(null==(a=u.data)?void 0:a.files)&&(c=c.concat(u.data.files),(null==(d=u.data)?void 0:d.isAll)?r({code:200,data:c,msg:""}):(null==(p=u.data)?void 0:p.nextFileTime)&&(e.append("startTime",u.data.nextFileTime),l().catch(s))),r({code:200,data:[],msg:""}),[2])}}))},u=function(){var e=this,t=arguments;return new Promise((function(n,o){var i=d.apply(e,t);function r(e){a(i,n,o,r,s,"next",e)}function s(e){a(i,n,o,r,s,"throw",e)}r(void 0)}))},u.apply(this,arguments)}l().catch(s)}))}function s(e){var t=e.slice(0,4),n=e.slice(4,6),o=e.slice(6,8),a=e.slice(8,10),i=e.slice(10,12),r=e.slice(12,14);return new Date(t+"/"+n+"/"+o+" "+a+":"+i+":"+r)}var l=function(){function a(e){if(!e)throw new Error("options is required");var t;this._options=e,/^http[s]?:\/\//.test(null!=(t=null==e?void 0:e.domain)?t:"")||(this._options.domain=n)}var i=a.prototype;return i.getDeviceCapacity=function(){return function(e,t){if(e&&"[object FormData]"!==Object.prototype.toString.call(e)){var a=new FormData;Object.entries(e).forEach((function(e){var t=e[0],n=e[1];a.append(t,n)})),e=a}return o((null!=t?t:n)+"/api/lapp/device/capacity",{method:"POST",body:e})}(e(this._options,["accessToken","deviceSerial"]),this._options.domain)},i.getDeviceInfo=function(){return function(e,t){if(e&&"[object FormData]"!==Object.prototype.toString.call(e)){var a=new FormData;Object.entries(e).forEach((function(e){var t=e[0],n=e[1];a.append(t,n)})),e=a}return o((null!=t?t:n)+"/api/lapp/device/info",{method:"POST",body:e})}(e(this._options,["accessToken","deviceSerial"]),this._options.domain)},i.getRealPlayUrl=function(t){var a,i,r=this,s=null==(i=this._options)||null==(a=i.extraParams)?void 0:a.ezopenParams;return function(e,t){if(e&&"[object FormData]"!==Object.prototype.toString.call(e)){var a,i,r=new FormData;r.append("isFlv","false"),r.append("userAgent",null==(i=window)||null==(a=i.navigator)?void 0:a.userAgent),r.append("isHttp","false"),Object.entries(e).forEach((function(e){var t=e[0],n=e[1];r.append(t,n)})),e=r}return o((null!=t?t:n)+"/api/lapp/live/url/ezopen",{method:"POST",body:e})}(t=Object.assign({},e(this._options,["accessToken"]),t,"object"==typeof s?s:{}),this._options.domain).then((function(e){var t,n,o,a,i,s,l,c,u,d,p="",m="",f="";if((null==e||null==(t=e.ext)?void 0:t.token)?(m+=e.data,f=e.ext.token,p=e.data):(null==(n=e.data)?void 0:n.token)&&(m+=e.data.url,f=e.data.token,p=e.data.url),m=m.includes("live")?m+"&ssn="+f+"&auth=1&biz=4&cln=100":m+"&ssn="+f+"&auth=1&cln=100",null==(a=r._options)||null==(o=a.extraParams)?void 0:o.wsParams)if("string"==typeof(null==(s=r._options)||null==(i=s.extraParams)?void 0:i.wsParams))m+="&"+(null==(d=r._options)||null==(u=d.extraParams)?void 0:u.wsParams);else if("object"==typeof(null==(c=r._options)||null==(l=c.extraParams)?void 0:l.wsParams)){var v,h;for(var b in null==(h=r._options)||null==(v=h.extraParams)?void 0:v.wsParams){var y,T;m+="&"+b+"="+(null==(T=r._options)||null==(y=T.extraParams)?void 0:y.wsParams[b])}}return{playUrl:p,stream:f,realUrl:m}}))},i.getVideoByTime=function(t){return r(t=Object.assign({},e(this._options,["accessToken","deviceSerial"]),t),this._options.domain)},i.getRecordCloudVideoByTime=function(a){return function(e,a){var i,r,l={startTime:e.startTime?null==(i=t(e.startTime))?void 0:i.format("YYYY-MM-DD HH:mm:ss"):void 0,endTime:e.startTime?null==(r=t(e.endTime))?void 0:r.format("YYYY-MM-DD HH:mm:ss"):void 0,spaceId:e.spaceId},c=Object.keys(l).reduce((function(e,t){return null==l[t]?e:e+="&"+t+"="+encodeURIComponent(l[t])}),"").replace("&","");return o((null!=a?a:n)+"/api/service/cloudrecord/video/info/list?"+c,{method:"GET",headers:{accessToken:e.accessToken,deviceSerial:e.deviceSerial,localIndex:e.channelNo}}).then((function(e){return e.data=(e.data||[]).map((function(e){return e.endTime=s(e.stopTime).getTime(),e.startTime=s(e.startTime).getTime(),e.iStorageVersion=e.istorageVersion,e.busType=7,delete e.istorageVersion,e})),e}))}(a=Object.assign({},e(this._options,["accessToken","deviceSerial"]),a),this._options.domain)},i.getThemeDetailById=function(e){return t={accessToken:this._options.accessToken,id:e},o((null!=(a=this._options.domain)?a:n)+"/api/service/media/template/getDetail?accessToken="+t.accessToken+"&id="+t.id,{method:"GET"});var t,a},i.setMirrorFlip=function(t){return function(e,t){if(e&&"[object FormData]"!==Object.prototype.toString.call(e)){var a=new FormData;Object.entries(e).forEach((function(e){var t=e[0],n=e[1];a.append(t,n)})),e=a}return o((null!=t?t:n)+"/api/lapp/device/ptz/mirror",{method:"POST",body:e})}(t=Object.assign({},e(this._options,["accessToken","deviceSerial"]),t),this._options.domain)},i.getVideoByID=function(e){return function(e,t){if(e&&"[object FormData]"!==Object.prototype.toString.call(e)){var a=new FormData;Object.entries(e).forEach((function(e){var t=e[0],n=e[1];a.append(t,n)})),e=a}return o((null!=t?t:n)+"/api/lapp/video/by/id",{method:"POST",body:e})}(e,this._options.domain)},i.getVersion=function(){return this.version},a}();export{l as default};
